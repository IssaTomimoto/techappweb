[← 第8章 Webアプリケーションの構築](08.md)

# Webアプリケーションのセキュリティ

## 前提知識

### HTTPS

### セッションとクッキー

#### セッション管理

[第7章](07.md)で構築した環境で動作するコードを使って説明する。

> [!IMPORTANT]
> 「送信された名前を記憶する」という例を使って，Webサーバがクライアントを識別できることを示す。

1. http://localhost/session.php?username=Taro にアクセスすると，「Hello, Taro.」と表示される。
1. 同じブラウザでhttp://localhost/session.php?username=Yabuki にアクセスすると，「Hello, Yabuki.」と表示される。
1. 同じブラウザでhttp://localhost/session.php にアクセスすると，やはり「Hello, Yabuki.」と表示される。

[session.php](app/html/session.php)では，1や2のクエリで指定された`username`の値をサーバサイドで記録している。3のように同じブラウザでアクセスすると，その値を使うようにしてある。

Firefoxの**ウェブ開発ツール**，Chromeの**デベロッパーツール**等でネットワークの状況を確認すると，リクエストヘッダに「`Cookie: PHPSESSID=0g91q0uk37r8c66s05476uhrfa`」という項目があり，リクエスト時にクライアントからサーバにクッキーが送信されていることがわかる。

![](img/09-cookie-b.png)

このクッキーがあれば，別のクライアントからでも同じセッションにアクセスできる。例えば，次のようにcURLを使ってアクセスすると，「Hello, Yabuki.」と表示される。

```bash
curl 'http://localhost/session.php' -H 'Cookie: PHPSESSID=0g91q0uk37r8c66s05476uhrfa'
```

> [!TIP]
> 開発ツールやデベロッパーツールには，cURLでアクセスするためのコマンドをクリップボードにコピーする機能があり，これがブラウザの動作をコマンドで再現したい場合に便利である。

#### クッキーによるユーザの追跡

> [!IMPORTANT]
> サードパーティークッキーを使って，異なるドメインのウェブサイト間でユーザを追跡する。

サイト|ホスト|コンテンツ
--|--|--
Blog-A|ホストA（localhost:3000）|tracking.html
SNS-B|ホストB（localhost）|session.php, good.php

次のような状況を想定する。

- 運営者の異なる二つのWebサイト，Blog-AとSNS-Bがある。
- SNS-Bのhttp://localhost/session.php?name=Yabuki にアクセスすると，セッションが生成され，クッキーが保存される。
- Blog-Aの[tracking.html](app/tracking.html) には，SNS-Bの画像http://localhost/good.php が埋め込まれている。

![](img/09-tracking-b.png)

> [!IMPORTANT]
> SNS-Bのユーザ（Yabuki）の，SNS-Bとは無関係なBlog-Aでの行動が，SNS-Bのログに記録される。

1. Blog-AのためのWebサーバAを起動する。

```bash
php -S 0.0.0.0:3000 -t /var/www/techappweb/07-09/app
```

2. SNS-Bのhttp://localhost/session.php?username=Yabuki にアクセスして，SNS-Bのクッキーを取得する。
3. Blog-Aのhttp://localhost:3000/tracking.html に，同じブラウザでアクセスする。
4. Ctrl-CでWebサーバAを停止させる。
5. 「`tail /var/log/apache2/error.log`」として，SNS-Bのログを確認する，次のような記録が確認できる。

```
[Tue Oct 31 11:12:21.726166 2023] [php:notice] [pid 11192] [client 172.17.0.1:46666] Yabuki, referer: http://localhost:3000/
```

このSNS-Bのログから，ユーザYabukiがSNS-Bとは無関係なBlog-A（http://localhost:3000/ ）にアクセスしたことがわかる。

## 開発者側が注意すべきこと

> [!CAUTION]
> ここで紹介する例は，自分で用意した実験用の環境でのみ試すべきである。

### CSRF

> [!IMPORTANT]
> Blog-Aの[csrf.html](app/csrf.html)を閲覧すると，Blog-Aとは無関係なSNS-Bを操作することになる。

1. 実験用のウェブサーバを起動する。

```bash
php -S 0.0.0.0:3000 -t /var/www/techappweb/07-09/app
```

2. 被害者が，SNS-Bのhttp://localhost/session.php?username=Yabuki にアクセスして，SNS-Bのクッキーを取得する。
3. 被害者が，Blog-Aのhttp://localhost:3000/csrf.html に，同じブラウザでアクセスする。
4. 被害者が，SNS-Bのhttp://localhost/session.php に，同じブラウザでアクセスすると，「Hello, Yabuki.」ではなく，「Hello, XYZ.」と表示される。

### XSS

> [!IMPORTANT]
> 第三者のスクリプトが実行できる状態のページの悪用例を示す。

1. 被害者がhttp://localhost/session.php?username=Yabuki にアクセスして，クッキーを取得する。
1. 被害者がhttp://localhost/hello.php?username=%3Cscript%3Ealert%28document.cookie%29%3B%3C%2Fscript%3E にアクセスすると，このページに埋め込まれたスクリプト（JavaScriptのコード）によって，クッキーが盗まれる（この例では表示するだけ）。

![](img/09-xss1-b.png)

この問題は，[hello.php](app/html/hello.html)の代わりに[hello-safe.php](app/html/hello-safe.php)を使うと解決される。被害者がhttp://localhost/hello-safe.php?name=%3Cscript%3Ealert%28document.cookie%29%3B%3C%2Fscript%3E にアクセスしても，クッキーは盗まれない。

![](img/09-xss2-b.png)

### セッション固定化攻撃

1. 攻撃者が，「`curl -I http://localhost/session.php?username=XYZ`」でセッションを用意する（オプション「`-I`」でレスポンスヘッダを表示する。

```
# curl -I http://localhost/session.php?username=XYZ
HTTP/1.1 200 OK
Date: Fri, 27 Sep 2024 08:07:56 GMT
Server: Apache/2.4.58 (Ubuntu)
Set-Cookie: PHPSESSID=m3vkgshugnjgqicqaklh4iiphd; path=/
Expires: Thu, 19 Nov 1981 08:52:00 GMT
Cache-Control: no-store, no-cache, must-revalidate
Pragma: no-cache
Content-Type: text/html; charset=UTF-8
```

2. 被害者をhttp://localhost/hello.php?username=%3Cscript%3Edocument.cookie%3D%27PHPSESSID%3Dm3vkgshugnjgqicqaklh4iiphd%27%3B%3C%2Fscript%3E にアクセスさせる（このURLは`http://localhost/hello.php?username=<script>document.cookie='PHPSESSID=m3vkgshugnjgqicqaklh4iiphd';</script>`をパーセントエンコーディングしたものである）。
3. 被害者がそのサイト上でhttp://localhost/session.php?username=Yabuki などの活動をする。この活動は，攻撃者が用意したセッションで行われる。
4. 攻撃者もそのセッションにアクセスすることで，被害者の活動を知ることができる。

```bash
# curl http://localhost/session.php -H 'Cookie: PHPSESSID=m3vkgshugnjgqicqaklh4iiphd'
Hello, Yabuki.
```

この問題は，[session.php](app/html/session.php)の代わりに[session-safe.php](app/html/session-safe.php)を使うと解決される。被害者がhttp://localhost/session-safe.php?username=Alice などの活動をすると，攻撃者が用意したセッションは使えなくなり，攻撃者が被害者の活動について知ることはできなくなる。

### SQLインジェクション

（第8章で作成した）次のファイルにはSQLインジェクション脆弱性がある。

- [SQLite: search-sqlite.php](app/html/search-sqlite.php)
- [MySQL: search-mysql.php](app/html/search-mysql.php)
- [共通部分: search.php](app/html/search.php)（脆弱な実装）

全ての商品が取得される。これはアプリの作成者が意図した動作ではない。

- SQLite: http://localhost/search-sqlite.php?search_name=%27+OR+TRUE+%2D%2D+
- MySQL: http://localhost/search-mysql.php?search_name=%27+OR+TRUE+%2D%2D+

SQLインジェクション脆弱性を修正した実装は次の通り。

- [SQLite: search-safe-sqlite.php](app/html/search-safe-sqlite.php)（SQLite独自の変更はない。）
- [MySQL: search-safe-mysql.php](app/html/search-safe-mysql.php)（プリペアドステートメントをMySQLで処理する。）
- [共通部分: search-safe.php](app/html/search-safe.php)（プリペアドステートメントを使用する。）

「全ての商品が取得される」ということはない。

- SQLite: http://localhost/search-safe-sqlite.php?search_name=%27+OR+TRUE+%2D%2D+
- MySQL: http://localhost/search-safe-mysql.php?search_name=%27+OR+TRUE+%2D%2D+

MySQLにおけるプリペアドステートメントの処理を`tail /var/log/mysql/general.log`で確認する。

```
2024-09-26T08:06:54.301423Z        24 Connect   testuser@localhost on mydb using TCP/IP
2024-09-26T08:06:54.302708Z        24 Prepare   SELECT * FROM items WHERE name LIKE ?
2024-09-26T08:06:54.302762Z        24 Execute   SELECT * FROM items WHERE name LIKE '%\' OR TRUE -- %'
2024-09-26T08:06:54.302960Z        24 Close stmt
2024-09-26T08:06:54.302973Z        24 Quit
```

## 利用者が注意すべきこと

[← 第8章 Webアプリケーションの構築](08.md)
